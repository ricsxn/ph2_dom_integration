# Phase 2 DOM integration test
Docker container recipes to setup the integration test environment for phase 2 DOMs.

Docker images in this repository have been thought into two separated images, the first containing a basic set of mandatory packages, the second inherits the first image and provides the whole packages and configuration to host a fully operative phase 2 DOM integration test environment.
Below the list of images:

* km3base - The basic image containing general purpose packages
* km3test - The image containing the whole environment to perform phase 1 DOM integration tests.

## Image preparation

Users can easily build by their own images just issuing the following commands:

### To build km3base image:
```bash
cd km3base
make image
```

Above statements require a standard docker installation and to perform the operation it is necessary a considerable amount of time due to the huge amount of packages to install and the time required to build the JPP software.
Image files will require almost 6GB.

# km3test usage
The km3test is the image name to use in order to perform phase 1 integration tests.
The suggested way to execute the image file can be seen by the below command:

```bash
docker volume create km3test_mysql
docker volume create km3test_New_DOM_testing_data
docker run --name km3test -dit --net host\
   -v km3test_mysql:/var/lib/mysql\
   -v km3test_New_DOM_testing_data:/home/km3net/New_DOM_testing_data\
   -e DISPLAT=$DISPLAY\
   ph2_km3test:1.0
```

The container is using docker 'host' network type, this means that the container will share the network connectivity with the hosting machine. The host machine should be connected to the DOM network being sure autonegotiation is turned off and jumbo frames are enabled in the network card linked to the DOM network.

The use of the DISPLAY variable has a crucial importance to allow the user to control the DOM activity using the SlowControl GUI (testctrl\_N) and to show charts generated by test script such as: takePiezoData, compass\_accepTest, etc.

The km3test image can be configured using environment variables described below:

* DOM Network environment variables

  Below variables are used to define the DOM network configuration, repesented values are default values, then if necessary override them during container creation:
  ```bash
  DOMNET=192.168.1.0
  DOMNETMASK=255.255.255.0
  DOMNET_DHCP_FROM=192.168.1.10
  DOMNET_DHCP_TO=192.168.1.30
  NTP_HOST=192.168.1.1
  ```

* `KM3TEST_NOMYSQL` - Set it to non zero value to disable the mysql server. Disabling the mysql server the container will connect to the mysql instance running on the host machine (if present), in this case, please verify that the hosting machine is using the same `km3net` username used by the container, otherwise it is necessary to change the DB connection string on all TEDI scripts.
* `KM3TEST_NOSSH` - The km3image hosts its own SSH server this service can be useful for file copies or SSH tunneling operations; the container SSH port is configured to listen on port number 2222 in order to do not overlab the SSH port used by the container hosting machine.

* `KM3TEST_NONTP` - By default the container will host a NTP server listening at the host defined by the variable NTP_HOST in the Dockerfile. To override this setting just specify the environment variable NTP_HOST. Specifying the KM3TEST_NONTP variable, the NTP service will not start.

* `KM3TEST_NODHCPD` -  By default the container will host a DHCPD server. In such a case it is necessary to specify the variables:

  * `DHCPDIF` Test machine interface name of the DOM network
  * `WRSMAC`  MAC address of the WhiteRabbit switch
  * `WRSIP` (optional).  IP address of the WhiteRabbit switch, if not specified the default value will be used, calculated with `DOMNET` variable and 251 as last octet.
  * `ISWMAC` (optional). MAC address of the Intermediate switch (if any) between test host and WhiteRabbit
  * `ISWIP` (optional). IP Address of the Intermediate switch (if any), if not specified, the default value will be calculated using `DOMNET` variable and 252 as last octet.

  Specifying variables above a new `dhcpd.conf` file will be generated.

  Specifying the `KM3TEST_NODHCPD` variable, the NTP service will not start.

# Startup testing environment

Once the km3test container has been executed it is possible to start performing integration tests.
The first operation is to startup the test container using the command:

```bash
docker run\
   --name km3test\
   -tid\
   -e KM3TEST_NONTP=1\
   -e KM3TEST_NODHCPD=1\
   --network host\
   ph2_km3test:1.0
```

Then it is possible to connect it using:

`docker exec -ti km3test /bin/bash`

 or directly: `docker exec -ti km3test gnome-terminal`

 If this last command does not work, please verify the correctness of the passed DISPLAY variable at container creation, being sure X window connections are allowed by command `xhost +`.

**wargning** Once connecting to the continer using the above statemtns, the current user is `root` and the current path is `/usr`; so that the next action is to swith to the test user `km3net` using the command:

 `su - km3net`

 It is possible also possible to go directly to the `km3net` account using:

 `docker exec -ti km3test gnome-terminal -- /bin/bash -c "su - km3net"`

 When operating with the `km3net`user, the default DIPLAY setup passed during container creation will be lost and it is necessary to setup it again manually with:

 `export DISPLAY=<your DISPLAY setting>`

 Alternatively it is possible to exploit SSH port forwarding with:

 `ssh -Y -p 2222 -l km3net <km3test_ip>`

 **warning** When specify the server IP in the GUI, use the IP address of the docker hosting machine of the network interface linked with the DOM network.

 **warning** The image provides `java-1.8.0-openjdk.x86_64` and `java-11-openjdk.x86_64` as default. To change this configuration use the command: `sudo alternatives --config java`, selecting the alternative java version.

 To perform integration tests, just execute commands explained by the integration documentation.
 Belo some **examples**:

```bash
startTestEnv
```

**warning** This script starts to watch the `/var/log/messages` this is related to an evenutally local instance of a DHCP server that by default is not configured.

```bash
cd tedi
./newDOM.py bc:5f:f4:36:58:74 112
```

```bash
cd tedi
./takePiezoData.py 1112 noise
 ```

 **warning** In the GUI pay attention of the packet size value, if too high for the network card configuration (see MTU=9126), acoustic data may be lost during acquisition.

```bash
cd tedi
./takePiezoData.py 1112 pmt_signal
```

```bash
cd tedi
./takePMTData.py 1112
```
**warning** This test script may require additional configuration steps in order to let the simulated DAQ to properly work inside the test environment. Below a list of steps to check:

* DAQ may decide to select the wrong network interface to start its daemons. This can be berified checking logs at `$DATA_DIR/PMT_data/logs/`. The solution to this problem can be find verifying the return value of the command: `hostname --ip` and changing the `/etc/hosts` configuration accordingly in order to return the IP address of the network interfece dedicated to DOM testing.

* DAQ requires high efficiency network connectivity, please ensure MTU is set to 9000 (better 9126) and autonegotiation is off for the network interface dedicated to the DOM testing.


## WRS firmware update

* First download the [v5.0.1-18-g9c64fb1-20190408](https://drive.google.com/drive/u/2/folders/1u7sGFZ0Fdh0AGuDAJ8-5U5vnN5u5C3Av) firmware. It is suggested to place it into the directory: `/home/km3net/wrs/`

* To update the firmware, just execute: `scp  ~/wrs/wr-switch-sw-v5.0.1-18-g9c64fb1-20190408_binaries.tar  <wrs_ip>: /update/wrs-firmware.tar`, then reboot the switch. However since several other configurations are necessary (enable jumbo frames, autonegotiation off), it is suggested to use the wrs_setup.sh script coming from [cmdr_events](https://git.km3net.de/rbruno/cmdr_events) repository

## WWRS CLB Firmware (optional)

It might be necessary to update the CLBv4 firmware, in such a case, please refer to the firmare files:

|date|Image|Notes|
|----|---|---|
|14/05/2021|[v1.0.0a12](http://sftp.km3net.de/CLB_Builds/clbng-v1.0.0a12-fw.tar.gz)|First release prototype|
|25/05/2021|[v1.0.0a13m1](http://sftp.km3net.de/CLB_Builds/clbng-v1.0.0a13m1-fw.tar.gz)|Latest official|
|10/05/2021|[v1.0.0a13m1i2xfix](https://git.km3net.de/clb/clb/-/releases/v1.0.0a13m1i2xfix)|Temporary release fixing I2C to operate at 100kHz|
|06/10/2021|[v1.0.0a14m1-fw](http://sftp.km3net.de/CLB_Builds/clbng-v1.0.0a14m1-fw.tar.gz)|This release allows to selectively enabling PMTs and includes the fix above|
|06/10/2021|[v1.0.0b5m1-fw](https://sftp.km3net.de/CLB_Builds/clbng-v1.0.0b5m1-f89826d5-fw.tar.gz)||
|06/10/2021|[v1.0.0b6m1-fw](https://sftp.km3net.de/CLB_Builds/clbng-v1.0.0b6m1-b6a13952-fw.tar.gz)|Latest|

**warning** To use the firmware with the [DIA Test Client](https://git.km3net.de/rbruno/dia-test-client/-/tree/master/), extract the archive in `<DTC config dir>/firwmare`

## cmdr_events

It is higly suggested to use [cmdr_events](https://git.km3net.de/rbruno/cmdr_events) software packages to pilot the WWRS DOM. Please refer to the repository documentation for its usage.

# km3test version info

The table below summarizes container version and related packages versions.

|Version|JPP|[CLB](https://sftp.km3net.de/CLB_Builds/)|Root|
|---|---|---|---|
|v1.0|v17.3.2|[clb-client-v1.2.1](https://sftp.km3net.de/CLB_Builds/clb-client-v1.2.1.tar.gz)|v6.20.06|
