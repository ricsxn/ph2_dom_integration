# Phase 2 DOM integration test
Docker container recipes to setup the integration test environment for phase 2 DOMs.

Docker images in this repository have been thought into two separated images, the first containing a basic set of mandatory packages, the second inherits the first image and provides the whole packages and configuration to host a fully operative phase 2 DOM integration test environment.
Below the list of images:

* km3base - The basic image containing general purpose packages
* km3test - The image containing the whole environment to perform phase 1 DOM integration tests.

## Image preparation

Users can easily build by their own images just issuing the following commands:

### To build km3base image:
```bash
cd km3base
docker build -t km3/km3base:1.0 .
```

### To build km3base image:
```bash
cd km3test
docker build -t km3/km3base:1.0 .
```

Above statements require a standard docker installation and to perform both operation it is necessary a considerable amount of time due to the huge amount of packages to install and the compilation time for the JPP software.
Image files will require almost 6GB.

# km3test usage
The km3test is the image name to use in order to perform phase 1 integration tests.
The suggested way to execute the image file can be seen by the below command:

```bash
docker volume create km3test_mysql
docker volume create km3test_New_DOM_testing_data
docker run --name km3test -dit --net host\
   -v km3test_mysql:/var/lib/mysql\
   -v km3test_New_DOM_testing_data:/home/km3net/New_DOM_testing_data\
   -e DISPLAT=$DISPLAY\
   km3/km3test:1.0
```

The container is using docker 'host' network type, this means that the container will share the network connectivity with the hosting machine. The host machine should be connected to the DOM network being sure autonegotiation is turned off and jumbo frames are enabled in the network card linked to the DOM network.

The use of the DISPLAY variable has a crucial importance to allow the user to control the DOM activity using the SlowControl GUI (testctrl\_N) and to show charts generated by test script such as: takePiezoData, compass\_accepTest, etc.

The km3test image can be configured using two environment variables as described below:

* `KM3TEST_NOMYSQL` - Set it to non zero value to disable the mysql server. Disabling the mysql server the container will connect to the mysql instance running on the host machine (if present), in this case, please verify that the hosting machine is using the same `km3net` username used by the container, otherwise it is necessary to change the DB connection string on all TEDI scripts.
* `KM3TEST_NOSSH` - The km3image hosts its own SSH server this service can be useful for file copies or SSH tunneling operations; the container SSH port is configured to listen on port number 2222 in order to do not overlab the SSH port used by the container hosting machine.

* `KM3TEST_NONTP` - By default the container will host a NTP server listening at the host defined by the variable NTP_HOST in the Dockerfile. To override this setting just specify the environment variable NTP_HOST. Specifying the KM3TEST_NONTP variable, the NTP service will not start.

* `KM3TEST_NODHCPD` -  By default the container will host a DHCPD server when specifying the variable `DHCPDIF` specifying the interface name used for DOM network.
It is also possible to setup the following variables:
   * `WRSMAC` - MAC address of the white rabbit switch

   * `ISWMAC` - MAC address of the intermediate switch between test PC and WRS network. If you do not have such intermediate device, specify any value in it (Es. 00:00:00:00:00:00).
  
  Specifying variables above a new `dhcpd.conf` file will be generated taking in account given devices.

  Skpecifying the `KM3TEST_NODHCPD` variable, the NTP service will not start.

# Startup testing environment

Once the km3test container has been executed it is possible to start performing integration tests.
The first operation is to startup the test container using the command:

`docker run -d --name km3test --net host km3/km3test:1.0`

Then it is possible to connect it using:

`docker exec -ti km3test /bin/bash`

 or directly: `docker exec -ti km3test gnome-terminal`

 If this last command does not work, please verify the correctness of the passed DISPLAY variable at container creation, being sure X window connections are allowed by xhost (e.g. `xhost +`).

**wargning** Once connecting to the continer using the above statemtns, the current user is `root` and the current path is `/usr`; so that the next action is to swith to the test user `km3net` using the command:

 `su - km3net`

 It is possible also possible to go directly to the `km3net` account using:

 `docker exec -ti km3test gnome-terminal -- /bin/bash -c "su - km3net"`

 When operating with the `km3net`user, the default DIPLAY setup passed during container creation will be lost and it is necessary to setup it again manually with:

 `export DISPLAY=<your DISPLAY setting>`

 Alternatively it is possible to exploit SSH port forwarding with:

 `ssh -Y -p 2222 -l km3net <km3test_ip>`

 Once connected to the test container it is possible to start the slowcontrol GUI aplication executing:

 `testctrl_N 1`

 **warning** When specify the server IP in the GUI, use the IP address of the docker hosting machine of the network interface linked with the DOM network.

 **warning** It could be possible that using standard the Java interpreter (`java-1.8.0-openjdk.x86_64`), the java GUI will not start due to a `java.awt.GraphicsEnvironment.checkHeadless` exception, while other applications such as gnome-terminal are working correctly. In such a case it is suggested to swicht java configuration to the `java-11-openjdk.x86_64` using command: `sudo alternatives --config java`.

 To perform integration tests, just execute commands explained by the integration documentation.
 Belo some **examples**:

```bash
startTestEnv
```

**warning** This script starts to watch the `/var/log/messages` this is related to an evenutally local instance of a DHCP server that by default is not configured.

```bash
cd tedi
./newDOM.py bc:5f:f4:36:58:74 112
```

```bash
cd tedi
./takePiezoData.py 1112 noise
 ```

 **warning** In the slowcontrol GUI pay attention of the packet size value, if too high for the network card setting acoustic data may be lost during acquisition.

```bash
cd tedi
./takePiezoData.py 1112 pmt_signal
```

```bash
cd tedi
./takePMTData.py 1112
```
**warning** This test script may require additional configuration steps in order to let the simulated DAQ to properly work inside the test environment. Below a list of steps to check:

* DAQ may decide to select the wrong network interface to start its daemons. This can be berified checking logs at `$DATA_DIR/PMT_data/logs/`. The solution to this problem can be find verifying the return value of the command: `hostname --ip` and changing the `/etc/hosts` configuration accordingly in order to return the IP address of the network interfece dedicated to DOM testing.

* DAQ requires high efficiency network connectivity, please ensure MTU is set to 9000 (better 9126) and autonegotiation is off for the network interface dedicated to the DOM testing.


# Advanced use and next features

With the the current container version is is possible to fully perform functional and acceptance tests, however to support WWRS tests some further configurations are necessary.
Below these configurationsteps are introduced but, to obtain more detailed information, please refer to [WWRS DOM setuo for integration and test](https://docs.google.com/document/d/1JFzmZ0CjEAoheMIl1L-vFrb4rHwDtwRQ4mFYz4Z-vwo/edit?usp=sharing)

## WRS firmware update

* First download the [v5.0.1-18-g9c64fb1-20190408](https://drive.google.com/drive/u/2/folders/1u7sGFZ0Fdh0AGuDAJ8-5U5vnN5u5C3Av) firmware. It is suggested to place it into the directory: `/home/km3net/wrs/`

* To update the firmware, just execute: `scp  ~/wrs/wr-switch-sw-v5.0.1-18-g9c64fb1-20190408_binaries.tar  <wrs_ip>: /update/wrs-firmware.tar`, then reboot the switch. However since several other configurations are necessary (enable jumbo frames, autonegotiation off), it is suggested to use the wrs_setup.sh script coming from [cmdr_events](https://git.km3net.de/rbruno/cmdr_events) repository

## WWRS CLB Firmware (optional)

It might be necessary to update the CLBv4 firmware, in such a case, please refer to the firmare files:

|date|Image|Notes|
|----|---|---|
|14/05/2021|[v1.0.0a12](http://sftp.km3net.de/CLB_Builds/clbng-v1.0.0a12-fw.tar.gz)|First release prototype|
|25/05/2021|[v1.0.0a13m1](http://sftp.km3net.de/CLB_Builds/clbng-v1.0.0a13m1-fw.tar.gz)|Latest official|
|10/05/2021|[v1.0.0a13m1i2xfix](https://git.km3net.de/clb/clb/-/releases/v1.0.0a13m1i2xfix)|Temporary release fixing I2C to operate at 100kHz|
|06/10/2021|[v1.0.0a14m1-fw](http://sftp.km3net.de/CLB_Builds/clbng-v1.0.0a14m1-fw.tar.gz)|This release allows to selectively enabling PMTs and includes the fix above|

## clb-client

To communicate with the CLB and manage its internal working statuses, it is necessary to download a control a specific version of clb-client tools.

|date|Image|Notes|
|----|---|---|
|01/06/2021|[clb-client-v1.1.0b](http://sftp.km3net.de/CLB_Builds/clb-client-v1.1.0b.tar.gz)|Latest|

Once downloaded the clb-client tools, it is necessary to update the km3net user path with the commands:

```bash
echo "# CLBv4 settings" >> ~/.bashrc
echo "PATH=$PATH:$HOME/clb-client-v1.1.0b/bin" >> ~/.bashrc
```

## Java configuration

The new clb-client tools require Java 11, already supported by the km3test container, it is necessary only to swith java configuration to point this release, using the command: `sudo alternatives --config java`

## cmdr_events

It is higly suggested to use [cmdr_events](https://git.km3net.de/rbruno/cmdr_events) software packages to pilot the WWRS DOM. Please refer to the repository documentation for its usage.

# km3test version info

The table below summarizes container version and related packages versions.

|Version|JPP|CLB|Root|
|---|---|---|---|
|v1.0|v17.3.2|20210315|v6.20.06|
